# Инструкция по установке сервиса интеграции
редакция №2

e-mail: laa@carddex.ru



Схема взаимодействия подсистем
--

Carddex-IMS <- Web service -> DB of ERP

Точки сопряжения WS

№ | Операция | URI |Входные параметры | Выходные | Примечание
--- | --- | --- | -- | --- | ---
 1. | getPersonList     | /person    |                         | []PersonData    |
 2. | updateTimeSheet   | /timesheet | []TimeSheet_record       | |
 3. | setPersonCard     |            | accountId, cardNumber  | | Не реализовано, требуется обоснование



Развертывание сервиса интеграции с ERP.
--

* Сервис представляет из себя исполняемый файл.
Желательно устанавливать его на одной машине с БД, чтобы нивелировать задерждки, тайм-ауты и возможные в их следствии подвисания транзакций и блокировки записей.


* Создать в базе таблицу.

```
CREATE TABLE TestItonBD.dbo.ТабельРабочегоВремени (
    Дата datetime NOT NULL,
    Идентификатор int NOT NULL,
    ВремяВхода datetime NOT NULL,
    ВремяВыхода datetime NOT NULL,
    СуммаВремя int NOT NULL,    
    CONSTRAINT PK_ТабельРВ PRIMARY KEY (Дата,Идентификатор),
    CONSTRAINT FK_ТабельРВ_Сотрудник FOREIGN KEY (Идентификатор) REFERENCES TestItonBD.dbo.СотрудникНабор(Идентификатор) ON DELETE CASCADE ON UPDATE CASCADE
);
```
Примечание:
Для поля `Идентификатор`, поскольку оно ссылается на внешнюю таблицу, возможно не помешает отдельный индекс.

* В файле config.ini прописать логин / пароль и имя хоста базы данных -- желательно локалхост (см. п1).

* Далее потребуется дополнительная настройка системы электронной проходной Carddex-IMS.

  1. В каталоге Carddex-IMS откройте текстовым редактором файл config.json. В строке
  ```
  "sync.erp.url": "http://127.0.0.1:3000/",
  ```
  укажите IP-адрес сервера, на котором запущен сервис интеграции.

  2. Через веб-интерфейс -- раздел "Персонал" удалите весь персонал из Carddex-IMS, чтобы не возникло конфликтов с ERP.
  3. Перезапустите сервис Carddex-IMS, чтобы настройки вступили в силу.
  4. После перезапуска, если все настроено верно, в Carddex-IMS должны появиться учетки из ERP.
  5. Далее необходимо присвоить персоналу номера карточек. Это можно осуществить вручную через веб-интерфейс в разделе Персонал.

